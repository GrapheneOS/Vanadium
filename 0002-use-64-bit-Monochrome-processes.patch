From d9ab84a7b19ef76c846b4dde674ff13d082ee360 Mon Sep 17 00:00:00 2001
From: Daniel Micay <danielmicay@gmail.com>
Date: Wed, 5 Jul 2017 00:22:37 -0400
Subject: [PATCH 02/19] use 64-bit Monochrome processes

---
 android_webview/BUILD.gn                      |  2 ++
 android_webview/system_webview_apk_tmpl.gni   |  2 +-
 chrome/android/BUILD.gn                       | 25 +++++--------------
 chrome/android/chrome_public_apk_tmpl.gni     | 17 ++-----------
 .../java/AndroidManifest_monochrome.xml       |  1 -
 ...hrome_android_manifest_jinja_variables.gni |  1 -
 6 files changed, 11 insertions(+), 37 deletions(-)

diff --git a/android_webview/BUILD.gn b/android_webview/BUILD.gn
index 535f0b9bbe91..fe126b225af0 100644
--- a/android_webview/BUILD.gn
+++ b/android_webview/BUILD.gn
@@ -425,7 +425,9 @@ if (android_64bit_target_cpu) {
       "//v8($android_secondary_abi_toolchain)",
     ]
   }
+}
 
+if (android_64bit_target_cpu && current_toolchain == android_secondary_abi_toolchain) {
   shared_library("monochrome") {
     deps = [
       ":webview_entry_point",
diff --git a/android_webview/system_webview_apk_tmpl.gni b/android_webview/system_webview_apk_tmpl.gni
index 819907a3a9fa..52e39a792cd8 100644
--- a/android_webview/system_webview_apk_tmpl.gni
+++ b/android_webview/system_webview_apk_tmpl.gni
@@ -35,7 +35,7 @@ template("system_webview_apk_tmpl") {
       # Include placeholder libraries to ensure we are treated as the desired
       # architecture.
       if (android_64bit_target_cpu) {
-        shared_libraries = [ "//android_webview:monochrome" ]
+        shared_libraries = [ "//chrome/android:monochrome" ]
         if (build_apk_secondary_abi) {
           secondary_native_lib_placeholders = [ "libdummy.so" ]
         }
diff --git a/chrome/android/BUILD.gn b/chrome/android/BUILD.gn
index 85234d43b441..db7aa7fae563 100644
--- a/chrome/android/BUILD.gn
+++ b/chrome/android/BUILD.gn
@@ -1165,16 +1165,7 @@ if (current_toolchain == default_toolchain) {
       }
 
       generate_resource_whitelist(_resource_whitelist_target) {
-        _fat_lib_toolchain = ""
-        if (_is_monochrome) {
-          # Always use the 32-bit library's whitelist since the 64-bit one is
-          # webview-only.
-          if (!android_64bit_target_cpu) {
-            _fat_lib_toolchain = current_toolchain
-          } else {
-            _fat_lib_toolchain = android_secondary_abi_toolchain
-          }
-        }
+        _fat_lib_toolchain = current_toolchain
         deps = [
           ":${_target}($_fat_lib_toolchain)",
         ]
@@ -1325,14 +1316,8 @@ if (current_toolchain == default_toolchain) {
   }
 }  # current_toolchain == host_toolchain
 
-#
-# Only 32-bit //chrome/android/monochrome is needed, beside
-# being built with 32-bit default toolchain, it is also built
-# with secondary 32-bit toolchain in 64-bit platform because we
-# need 64-bit //android_webview/monochrome and 32-bit this target
-# for 64-bit APK.
 if (!android_64bit_target_cpu ||
-    current_toolchain == android_secondary_abi_toolchain) {
+    current_toolchain != android_secondary_abi_toolchain) {
   chrome_common_shared_library("monochrome") {
     sources = [
       "../browser/android/monochrome_entry_point.cc",
@@ -1345,10 +1330,12 @@ if (!android_64bit_target_cpu ||
     enable_compressed_relocations = use_lld
     use_gnu_hash_style = true
   }
-} else {
+}
+
+if (android_64bit_target_cpu && current_toolchain != android_secondary_abi_toolchain) {
   group("monochrome_secondary_abi_lib") {
     public_deps = [
-      ":monochrome($android_secondary_abi_toolchain)",
+      "//android_webview:monochrome($android_secondary_abi_toolchain)",
     ]
   }
 }
diff --git a/chrome/android/chrome_public_apk_tmpl.gni b/chrome/android/chrome_public_apk_tmpl.gni
index 3915df1fcb8e..a8de0e560f04 100644
--- a/chrome/android/chrome_public_apk_tmpl.gni
+++ b/chrome/android/chrome_public_apk_tmpl.gni
@@ -218,26 +218,13 @@ template("monochrome_public_common_apk_or_module_tmpl") {
   chrome_public_common_apk_or_module_tmpl(target_name) {
     if (!defined(invoker.use_trichrome_library) ||
         !invoker.use_trichrome_library) {
-      # Always build 64-bit //android_webview:monochrome because Chrome runs
-      # in 32-bit mode.
-      if (android_64bit_target_cpu) {
-        shared_libraries = [ "//android_webview:monochrome" ]
-      } else {
-        shared_libraries = [ "//chrome/android:monochrome" ]
-      }
+      shared_libraries = [ "//chrome/android:monochrome" ]
       if (android_64bit_target_cpu && build_apk_secondary_abi) {
         secondary_abi_shared_libraries =
             [ "//chrome/android:monochrome_secondary_abi_lib" ]
       }
     } else {
-      # Include a 32-bit placeholder library to ensure that Chrome runs in
-      # 32-bit mode.
-      if (android_64bit_target_cpu) {
-        # We don't want to be 64-bit, only include a placeholder for secondary.
-        secondary_native_lib_placeholders = [ "libdummy.so" ]
-      } else {
-        native_lib_placeholders = [ "libdummy.so" ]
-      }
+      native_lib_placeholders = [ "libdummy.so" ]
     }
     if (invoker.add_unwind_tables_in_apk) {
       shared_library_for_unwind_asset = "monochrome"
diff --git a/chrome/android/java/AndroidManifest_monochrome.xml b/chrome/android/java/AndroidManifest_monochrome.xml
index 5ae85dec51d1..934d13d806dc 100644
--- a/chrome/android/java/AndroidManifest_monochrome.xml
+++ b/chrome/android/java/AndroidManifest_monochrome.xml
@@ -19,7 +19,6 @@
 {{ super() }}
 android:multiArch="true"
 android:extractNativeLibs="false"
-{{use32bitAbi|default('')}}
 {% endblock %}
 
 {% block extra_keyset_definitions %}
diff --git a/chrome/android/monochrome_android_manifest_jinja_variables.gni b/chrome/android/monochrome_android_manifest_jinja_variables.gni
index dcbfa96764a1..8e6d7ccac9e2 100644
--- a/chrome/android/monochrome_android_manifest_jinja_variables.gni
+++ b/chrome/android/monochrome_android_manifest_jinja_variables.gni
@@ -5,5 +5,4 @@
 monochrome_android_manifest_jinja_variables = [
   "min_sdk_version=24",
   "sandboxed_service_exported=true",
-  "use32bitAbi=android:use32bitAbi=\"true\"",
 ]
-- 
2.20.1

