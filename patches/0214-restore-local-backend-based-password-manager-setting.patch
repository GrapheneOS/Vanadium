From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Fri, 25 Jul 2025 11:56:54 +0000
Subject: [PATCH] restore local backend based password manager settings support

---
 .../browser/password_manager/android/BUILD.gn |  8 +++++
 .../PasswordManagerHelper.java                | 12 +++++++
 .../PasswordsPreferenceHelper.java            | 34 +++++++++++++++++++
 .../settings/PasswordsPreference.java         |  4 +++
 ...ssword_manager_settings_service_factory.cc |  3 +-
 5 files changed, 60 insertions(+), 1 deletion(-)
 create mode 100644 chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java

diff --git a/chrome/browser/password_manager/android/BUILD.gn b/chrome/browser/password_manager/android/BUILD.gn
index 014eaa48197e8..3dd5d4a17ebee 100644
--- a/chrome/browser/password_manager/android/BUILD.gn
+++ b/chrome/browser/password_manager/android/BUILD.gn
@@ -199,6 +199,14 @@ android_library("java") {
     "java/src/org/chromium/chrome/browser/password_manager/settings/SavedPasswordEntry.java",
   ]
 
+  sources += [
+    "java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java",
+  ]
+
+  srcjar_deps += [
+    "//chrome/browser/password_manager/android/buildflags:buildflags_srcjar",
+  ]
+
   resources_package = "org.chromium.chrome.browser.password_manager"
 }
 
diff --git a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java
index 8a7d2cfe24d78..062815816e45d 100644
--- a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java
+++ b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java
@@ -130,6 +130,12 @@ public class PasswordManagerHelper {
             boolean managePasskeys,
             @Nullable String account,
             SettingsCustomTabLauncher settingsCustomTabLauncher) {
+        if (PasswordsPreferenceHelper.shouldUseLocalPasswordBackend()) {
+            PasswordsPreferenceHelper.navigateToLocalPasswordManagerBackendSetting(
+                    context, referrer);
+            return;
+        }
+
         RecordHistogram.recordEnumeratedHistogram(
                 "PasswordManager.ManagePasswordsReferrer",
                 referrer,
@@ -461,6 +467,12 @@ public class PasswordManagerHelper {
             Supplier<@Nullable ModalDialogManager> modalDialogManagerSupplier,
             Context context,
             @Nullable SettingsCustomTabLauncher settingsCustomTabLauncher) {
+        if (PasswordsPreferenceHelper.shouldUseLocalPasswordBackend()) {
+            PasswordsPreferenceHelper.navigateToLocalPasswordManagerBackendSetting(
+                    context, referrer);
+            return;
+        }
+
         PasswordCheckupClientHelper checkupClient;
         try {
             checkupClient = getPasswordCheckupClientHelper();
diff --git a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java
new file mode 100644
index 0000000000000..2ca86dee9c413
--- /dev/null
+++ b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java
@@ -0,0 +1,34 @@
+// Copyright 2025 GrapheneOS
+// Use of this source code is governed by a GPL 2.0-style license that can be
+// found in the LICENSE file.
+
+package org.chromium.chrome.browser.password_manager;
+
+import static org.chromium.chrome.browser.password_manager.PasswordManagerHelper.MANAGE_PASSWORDS_REFERRER;
+import static org.chromium.chrome.browser.password_manager.PasswordManagerBuildflags.USE_LOGIN_DATABASE_AS_BACKEND;
+
+
+import android.content.Context;
+import android.os.Bundle;
+
+import org.chromium.chrome.browser.settings.SettingsNavigationFactory;
+import org.chromium.components.browser_ui.settings.SettingsNavigation.SettingsFragment;
+
+public final class PasswordsPreferenceHelper {
+
+    static void navigateToLocalPasswordManagerBackendSetting(
+            Context context,
+            @ManagePasswordsReferrer int referrer) {
+        Bundle fragmentArgs = new Bundle();
+        fragmentArgs.putInt(MANAGE_PASSWORDS_REFERRER, referrer);
+        context.startActivity(
+                SettingsNavigationFactory.createSettingsNavigation()
+                        .createSettingsIntent(context, SettingsFragment.PASSWORDS, fragmentArgs));
+    }
+
+    public static boolean shouldUseLocalPasswordBackend() {
+        return USE_LOGIN_DATABASE_AS_BACKEND;
+    }
+
+    private PasswordsPreferenceHelper() {}
+}
diff --git a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java
index 1836b36e96039..4247590a347a3 100644
--- a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java
+++ b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java
@@ -63,6 +63,10 @@ public class PasswordsPreference extends ChromeBasePreference implements Profile
         PrefService prefService =
                 sPrefServiceForTesting != null ? sPrefServiceForTesting : UserPrefs.get(mProfile);
 
+        if (org.chromium.chrome.browser.password_manager.PasswordsPreferenceHelper.shouldUseLocalPasswordBackend()) {
+            return;
+        }
+
         if (prefService.isManagedPreference(Pref.CREDENTIALS_ENABLE_SERVICE)) {
             setUpManagedDisclaimerView(holder, prefService);
         }
diff --git a/chrome/browser/password_manager/password_manager_settings_service_factory.cc b/chrome/browser/password_manager/password_manager_settings_service_factory.cc
index 27b46915ddb44..8ca423c4e52f0 100644
--- a/chrome/browser/password_manager/password_manager_settings_service_factory.cc
+++ b/chrome/browser/password_manager/password_manager_settings_service_factory.cc
@@ -10,6 +10,7 @@
 #include "chrome/browser/webid/federated_identity_auto_reauthn_permission_context.h"
 #include "chrome/browser/webid/federated_identity_auto_reauthn_permission_context_factory.h"
 #include "components/password_manager/core/browser/features/password_features.h"
+#include "components/password_manager/core/browser/password_manager_buildflags.h"
 #include "components/password_manager/core/browser/password_manager_settings_service.h"
 #include "components/password_manager/core/browser/password_manager_settings_service_impl.h"
 #include "components/password_manager/core/common/password_manager_features.h"
@@ -83,7 +84,7 @@ PasswordManagerSettingsServiceFactory::BuildServiceInstanceForBrowserContext(
 
 std::unique_ptr<password_manager::PasswordManagerSettingsService>
 PasswordManagerSettingsServiceFactory::CreateService(Profile* profile) const {
-#if BUILDFLAG(IS_ANDROID)
+#if BUILDFLAG(IS_ANDROID) && !BUILDFLAG(USE_LOGIN_DATABASE_AS_BACKEND)
   if (password_manager_android_util::IsPasswordManagerAvailable(
           std::make_unique<
               password_manager_android_util::PasswordManagerUtilBridge>())) {
