From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Fri, 29 Mar 2024 13:26:23 +0000
Subject: [PATCH] Enable CredentialManager APIs for all apps supporting
 passkeys

---
 chrome/browser/webauthn/android/BUILD.gn          |  1 +
 .../webauthn/CredManUiRecommenderImpl.java        | 15 +++++++++++++++
 device/fido/features.h                            |  2 +-
 3 files changed, 17 insertions(+), 1 deletion(-)
 create mode 100644 chrome/browser/webauthn/android/java/src/org/chromium/chrome/browser/webauthn/CredManUiRecommenderImpl.java

diff --git a/chrome/browser/webauthn/android/BUILD.gn b/chrome/browser/webauthn/android/BUILD.gn
index 4dd32cbc1207d..e0d119c9dfeb6 100644
--- a/chrome/browser/webauthn/android/BUILD.gn
+++ b/chrome/browser/webauthn/android/BUILD.gn
@@ -12,6 +12,7 @@ android_library("java") {
     "java/src/org/chromium/chrome/browser/webauthn/CableAuthenticatorModuleProvider.java",
     "java/src/org/chromium/chrome/browser/webauthn/ChromeAuthenticatorConfirmationFactory.java",
     "java/src/org/chromium/chrome/browser/webauthn/ChromeAuthenticatorFactory.java",
+    "java/src/org/chromium/chrome/browser/webauthn/CredManUiRecommenderImpl.java",
     "java/src/org/chromium/chrome/browser/webauthn/PrivacySettingsFragment.java",
   ]
 
diff --git a/chrome/browser/webauthn/android/java/src/org/chromium/chrome/browser/webauthn/CredManUiRecommenderImpl.java b/chrome/browser/webauthn/android/java/src/org/chromium/chrome/browser/webauthn/CredManUiRecommenderImpl.java
new file mode 100644
index 0000000000000..fcfc935c9218a
--- /dev/null
+++ b/chrome/browser/webauthn/android/java/src/org/chromium/chrome/browser/webauthn/CredManUiRecommenderImpl.java
@@ -0,0 +1,15 @@
+// Copyright 2024 The Chromium Authors
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+package org.chromium.chrome.browser.webauthn;
+
+import org.chromium.build.annotations.ServiceImpl;
+import org.chromium.components.webauthn.cred_man.CredManUiRecommender;
+
+@ServiceImpl(CredManUiRecommender.class)
+public class CredManUiRecommenderImpl implements CredManUiRecommender {
+    @Override
+    public boolean recommendsCustomUi() {
+        return true; // Use the platform CredMan APIs if available.
+    }
+}
diff --git a/device/fido/features.h b/device/fido/features.h
index 73b888997e8dd..90a3b52f8dd86 100644
--- a/device/fido/features.h
+++ b/device/fido/features.h
@@ -36,7 +36,7 @@ BASE_DECLARE_FEATURE(kWebAuthnAndroidCredMan);
 // Use the Android 14 Credential Manager API for credentials stored in Gmscore.
 COMPONENT_EXPORT(DEVICE_FIDO)
 inline constexpr base::FeatureParam<bool> kWebAuthnAndroidGpmInCredMan{
-    &kWebAuthnAndroidCredMan, "gpm_in_cred_man", false};
+    &kWebAuthnAndroidCredMan, "gpm_in_cred_man", true};
 #endif  // BUILDFLAG(IS_ANDROID)
 
 // These five feature flags control whether iCloud Keychain is the default
