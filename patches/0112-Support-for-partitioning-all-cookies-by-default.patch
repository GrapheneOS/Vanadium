From fcf4402b931e68c036d42aa07654c8250a58e0f4 Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Sat, 15 Apr 2023 04:06:19 +0000
Subject: [PATCH] Support for partitioning all cookies by default

---
 net/cookies/parsed_cookie.cc                                 | 5 +++++
 .../blink/renderer/modules/cookie_store/cookie_init.idl      | 2 +-
 .../blink/renderer/modules/cookie_store/cookie_store.cc      | 4 ++++
 .../modules/cookie_store/cookie_store_delete_options.idl     | 2 +-
 4 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/net/cookies/parsed_cookie.cc b/net/cookies/parsed_cookie.cc
index 32680825ead24..5d65028b37f35 100644
--- a/net/cookies/parsed_cookie.cc
+++ b/net/cookies/parsed_cookie.cc
@@ -655,6 +655,11 @@ void ParsedCookie::ParseTokenValuePairs(const std::string& cookie_line,
 }
 
 void ParsedCookie::SetupAttributes() {
+  // Coerce partitioned cookies when the feature is enabled.
+  if (base::FeatureList::IsEnabled(net::features::kPartitionedCookies)) {
+    SetIsSecure(true);
+    SetIsPartitioned(true);
+  }
   // We skip over the first token/value, the user supplied one.
   for (size_t i = 1; i < pairs_.size(); ++i) {
     if (pairs_[i].first == kPathTokenName) {
diff --git a/third_party/blink/renderer/modules/cookie_store/cookie_init.idl b/third_party/blink/renderer/modules/cookie_store/cookie_init.idl
index 93aca7f3ba598..6d02133c0f913 100644
--- a/third_party/blink/renderer/modules/cookie_store/cookie_init.idl
+++ b/third_party/blink/renderer/modules/cookie_store/cookie_init.idl
@@ -17,5 +17,5 @@ dictionary CookieInit {
   USVString path = "/";
   DOMHighResTimeStamp? expires = null;
   CookieSameSite sameSite = "strict";
-  [RuntimeEnabled=PartitionedCookies] boolean partitioned = false;
+  [RuntimeEnabled=PartitionedCookies] boolean partitioned = true;
 };
diff --git a/third_party/blink/renderer/modules/cookie_store/cookie_store.cc b/third_party/blink/renderer/modules/cookie_store/cookie_store.cc
index 802d838519049..466a053540263 100644
--- a/third_party/blink/renderer/modules/cookie_store/cookie_store.cc
+++ b/third_party/blink/renderer/modules/cookie_store/cookie_store.cc
@@ -316,6 +316,10 @@ ScriptPromise CookieStore::set(ScriptState* script_state,
   CookieInit* set_options = CookieInit::Create();
   set_options->setName(name);
   set_options->setValue(value);
+  if (RuntimeEnabledFeatures::PartitionedCookiesEnabled(
+      CurrentExecutionContext(script_state->GetIsolate()))) {
+    set_options->setPartitioned(true);
+  }
   return set(script_state, set_options, exception_state);
 }
 
diff --git a/third_party/blink/renderer/modules/cookie_store/cookie_store_delete_options.idl b/third_party/blink/renderer/modules/cookie_store/cookie_store_delete_options.idl
index 3379515199cb7..357cbef0a4144 100644
--- a/third_party/blink/renderer/modules/cookie_store/cookie_store_delete_options.idl
+++ b/third_party/blink/renderer/modules/cookie_store/cookie_store_delete_options.idl
@@ -8,5 +8,5 @@ dictionary CookieStoreDeleteOptions {
   required USVString name;
   USVString? domain = null;
   USVString path = "/";
-  [RuntimeEnabled=PartitionedCookies] boolean partitioned = false;
+  [RuntimeEnabled=PartitionedCookies] boolean partitioned = true;
 };
