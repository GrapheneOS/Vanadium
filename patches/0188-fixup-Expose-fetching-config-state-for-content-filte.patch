From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Sun, 14 Jul 2024 03:26:05 +0000
Subject: [PATCH] fixup! Expose fetching config state for content filtering to
 native calls

---
 .../SubresourceFilterFetching.java            |  8 +++++--
 .../subresource_filter_fetching.cc            | 21 ++++---------------
 .../subresource_filter_fetching.h             |  5 ++---
 3 files changed, 12 insertions(+), 22 deletions(-)

diff --git a/components/subresource_filter/android_config/java/src/org/chromium/components/subresource_filter/SubresourceFilterFetching.java b/components/subresource_filter/android_config/java/src/org/chromium/components/subresource_filter/SubresourceFilterFetching.java
index bd702d12432a9..f8bb67eaacf13 100644
--- a/components/subresource_filter/android_config/java/src/org/chromium/components/subresource_filter/SubresourceFilterFetching.java
+++ b/components/subresource_filter/android_config/java/src/org/chromium/components/subresource_filter/SubresourceFilterFetching.java
@@ -3,18 +3,17 @@ package org.chromium.components.subresource_filter;
 import org.jni_zero.CalledByNative;
 import org.jni_zero.JNINamespace;
 
+import app.vanadium.config.SubresourceFilterComponentUtils;
 import app.vanadium.config.VanadiumConfParser;
 import app.vanadium.config.proto.VanadiumConfigProto.Component.ComponentType;
 
 @JNINamespace("subresource_filter")
 public class SubresourceFilterFetching {
 
-    @CalledByNative
     public static long getUnindexedRulesetVersion() {
         return VanadiumConfParser.getVersionCodeForComponent(ComponentType.SUBRESOURCE_FILTER_TOOLS);
     }
 
-    @CalledByNative
     public static byte[] getUnindexedRulesetData() {
         return VanadiumConfParser.getByteArrayForComponent(ComponentType.SUBRESOURCE_FILTER_TOOLS);
     }
@@ -23,4 +22,9 @@ public class SubresourceFilterFetching {
     public static boolean isInitialized() {
         return VanadiumConfParser.isInitialized();
     }
+
+    @CalledByNative
+    public static boolean deleteUnindexedFile() {
+        return SubresourceFilterComponentUtils.deleteComponentFileForParsing();
+    }
 }
diff --git a/components/subresource_filter/android_config/subresource_filter_fetching.cc b/components/subresource_filter/android_config/subresource_filter_fetching.cc
index ca345bc361943..1130dca7c46fb 100644
--- a/components/subresource_filter/android_config/subresource_filter_fetching.cc
+++ b/components/subresource_filter/android_config/subresource_filter_fetching.cc
@@ -7,31 +7,18 @@
 #include <string>
 
 #include "base/android/jni_android.h"
-#include "base/android/jni_array.h"
-#include "base/strings/string_number_conversions.h"
 #include "components/subresource_filter/android_config/subresource_filter_fetching_jni_headers/SubresourceFilterFetching_jni.h"
 
 namespace subresource_filter {
 
-std::string GetUnindexedRulesetVersion() {
-  JNIEnv* env = base::android::AttachCurrentThread();
-  return base::NumberToString(Java_SubresourceFilterFetching_getUnindexedRulesetVersion(env));
-}
-
-std::string GetUnindexedRulesetData() {
-  using base::android::JavaByteArrayToString;
-  using base::android::ScopedJavaLocalRef;
-
+bool IsInitialized() {
   JNIEnv* env = base::android::AttachCurrentThread();
-  ScopedJavaLocalRef<jbyteArray> arr = Java_SubresourceFilterFetching_getUnindexedRulesetData(env);
-  std::string unindexed_ruleset_data_str;
-  JavaByteArrayToString(env, arr, &unindexed_ruleset_data_str);
-  return unindexed_ruleset_data_str;
+  return Java_SubresourceFilterFetching_isInitialized(env);
 }
 
-bool IsInitialized() {
+bool DeleteUnindexedSubresourceFile() {
   JNIEnv* env = base::android::AttachCurrentThread();
-  return Java_SubresourceFilterFetching_isInitialized(env);
+  return Java_SubresourceFilterFetching_deleteUnindexedFile(env);
 }
 
 }
diff --git a/components/subresource_filter/android_config/subresource_filter_fetching.h b/components/subresource_filter/android_config/subresource_filter_fetching.h
index 80d8054151594..6c1eef7897b6a 100644
--- a/components/subresource_filter/android_config/subresource_filter_fetching.h
+++ b/components/subresource_filter/android_config/subresource_filter_fetching.h
@@ -8,9 +8,8 @@
 #include <string>
 
 namespace subresource_filter {
-std::string GetUnindexedRulesetVersion();
-std::string GetUnindexedRulesetData();
 bool IsInitialized();
+bool DeleteUnindexedSubresourceFile();
 } // namespace subresource_filter
 
-#endif // COMPONENTS_SUBRESOURCE_FILTER_ANDROID_CONFIG_SUBRESOURCE_FILTER_FETCHING_H_
\ No newline at end of file
+#endif // COMPONENTS_SUBRESOURCE_FILTER_ANDROID_CONFIG_SUBRESOURCE_FILTER_FETCHING_H_
