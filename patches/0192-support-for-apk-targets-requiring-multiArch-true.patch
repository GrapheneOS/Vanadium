From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Mon, 14 Jul 2025 15:23:12 +0000
Subject: [PATCH] support for apk targets requiring multiArch=true

---
 build/config/android/abi.gni            | 8 ++++++++
 build/config/android/internal_rules.gni | 6 ++++++
 build/config/android/rules.gni          | 6 ++++++
 3 files changed, 20 insertions(+)

diff --git a/build/config/android/abi.gni b/build/config/android/abi.gni
index 8f6c5b19946df..054c0dd18b9f2 100644
--- a/build/config/android/abi.gni
+++ b/build/config/android/abi.gni
@@ -110,3 +110,11 @@ if (enable_android_secondary_abi) {
         "//build/toolchain/android:android_clang_${android_secondary_abi_cpu}"
   }
 }
+
+if (target_cpu == "arm64") {
+  android_app_secondary_abi_for_placeholder = "armeabi-v7a"
+} else if (target_cpu == "x64") {
+  android_app_secondary_abi_for_placeholder = "x86"
+} else if (target_cpu == "mips64el") {
+  android_app_secondary_abi_for_placeholder = "mips"
+}
diff --git a/build/config/android/internal_rules.gni b/build/config/android/internal_rules.gni
index 8f136746b2962..399bf23ea3509 100644
--- a/build/config/android/internal_rules.gni
+++ b/build/config/android/internal_rules.gni
@@ -2857,8 +2857,14 @@ if (enable_java_templates) {
         _native_lib_placeholders != []) {
       _args += [ "--android-abi=$android_app_abi" ]
     }
+    _requires_multi_abi = defined(invoker.requires_multi_abi) && invoker.requires_multi_abi
     if (defined(android_app_secondary_abi)) {
       _args += [ "--secondary-android-abi=$android_app_secondary_abi" ]
+    } else if (_requires_multi_abi) {
+      _args += [ "--secondary-android-abi=$android_app_secondary_abi_for_placeholder" ]
+    }
+    if (_requires_multi_abi) {
+      _args += [ "--is-multi-abi" ]
     }
     if (defined(invoker.loadable_modules) && invoker.loadable_modules != []) {
       _inputs += invoker.loadable_modules
diff --git a/build/config/android/rules.gni b/build/config/android/rules.gni
index 727c3f7dac985..5125bad971669 100644
--- a/build/config/android/rules.gni
+++ b/build/config/android/rules.gni
@@ -2181,6 +2181,10 @@ if (!is_robolectric && enable_java_templates) {
   #   suffix_apk_assets_used_by: Prefixes android assets used by the given apk
   #     with $package_name. Adds the list of renamed packages to
   #     BuildConfig.java.
+  #   requires_multi_abi: if true will add a library placeholder for the missing abi
+  #      if either the primary or the secondary abi has no native libraries set,
+  #      and if there is no android_app_secondary_abi present, it will fallback to
+  #      android_app_secondary_abi_for_placeholder.
   template("android_apk_or_module") {
     forward_variables_from(invoker, TESTONLY_AND_VISIBILITY)
     _template_name = target_name
@@ -3056,6 +3060,7 @@ if (!is_robolectric && enable_java_templates) {
       _create_apk_target = "${_template_name}__create"
       _final_deps += [ ":$_create_apk_target" ]
       package_apk("$_create_apk_target") {
+        forward_variables_from(invoker, [ "requires_multi_abi" ])
         forward_variables_from(invoker,
                                [
                                  "expected_libs_and_assets",
@@ -3348,6 +3353,7 @@ if (!is_robolectric && enable_java_templates) {
   #   }
   template("android_apk") {
     android_apk_or_module(target_name) {
+      forward_variables_from(invoker, [ "requires_multi_abi" ])
       forward_variables_from(
           invoker,
           [
