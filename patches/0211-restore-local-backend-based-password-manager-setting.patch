From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Fri, 25 Jul 2025 11:56:54 +0000
Subject: [PATCH] restore local backend based password manager settings support

---
 .../browser/password_manager/android/BUILD.gn |  8 +++++
 .../PasswordManagerHelper.java                |  6 ++++
 .../PasswordsPreferenceHelper.java            | 34 +++++++++++++++++++
 .../settings/PasswordsPreference.java         |  4 +++
 ...ssword_manager_settings_service_factory.cc |  3 +-
 5 files changed, 54 insertions(+), 1 deletion(-)
 create mode 100644 chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java

diff --git a/chrome/browser/password_manager/android/BUILD.gn b/chrome/browser/password_manager/android/BUILD.gn
index 21a3fd298a43c..3cd4365d563ae 100644
--- a/chrome/browser/password_manager/android/BUILD.gn
+++ b/chrome/browser/password_manager/android/BUILD.gn
@@ -201,6 +201,14 @@ android_library("java") {
     "java/src/org/chromium/chrome/browser/password_manager/settings/SavedPasswordEntry.java",
   ]
 
+  sources += [
+    "java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java",
+  ]
+
+  srcjar_deps += [
+    "//chrome/browser/password_manager/android/buildflags:buildflags_srcjar",
+  ]
+
   resources_package = "org.chromium.chrome.browser.password_manager"
 }
 
diff --git a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java
index 4153914532f3e..8ffc1cb1dfc39 100644
--- a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java
+++ b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordManagerHelper.java
@@ -141,6 +141,12 @@ public class PasswordManagerHelper {
 
         PrefService prefService = UserPrefs.get(mProfile);
 
+        if (PasswordsPreferenceHelper.shouldUseLocalPasswordBackend()) {
+            PasswordsPreferenceHelper.navigateToLocalPasswordManagerBackendSetting(
+                    context, referrer);
+            return;
+        }
+
         if (!PasswordManagerUtilBridge.isPasswordManagerAvailable(prefService)
                 && !prefService.getBoolean(Pref.UPM_UNMIGRATED_PASSWORDS_EXPORTED)) {
             // The automatic export is ongoing. Usually a dialog offering the user to download
diff --git a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java
new file mode 100644
index 0000000000000..2ca86dee9c413
--- /dev/null
+++ b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/PasswordsPreferenceHelper.java
@@ -0,0 +1,34 @@
+// Copyright 2025 GrapheneOS
+// Use of this source code is governed by a GPL 2.0-style license that can be
+// found in the LICENSE file.
+
+package org.chromium.chrome.browser.password_manager;
+
+import static org.chromium.chrome.browser.password_manager.PasswordManagerHelper.MANAGE_PASSWORDS_REFERRER;
+import static org.chromium.chrome.browser.password_manager.PasswordManagerBuildflags.USE_LOGIN_DATABASE_AS_BACKEND;
+
+
+import android.content.Context;
+import android.os.Bundle;
+
+import org.chromium.chrome.browser.settings.SettingsNavigationFactory;
+import org.chromium.components.browser_ui.settings.SettingsNavigation.SettingsFragment;
+
+public final class PasswordsPreferenceHelper {
+
+    static void navigateToLocalPasswordManagerBackendSetting(
+            Context context,
+            @ManagePasswordsReferrer int referrer) {
+        Bundle fragmentArgs = new Bundle();
+        fragmentArgs.putInt(MANAGE_PASSWORDS_REFERRER, referrer);
+        context.startActivity(
+                SettingsNavigationFactory.createSettingsNavigation()
+                        .createSettingsIntent(context, SettingsFragment.PASSWORDS, fragmentArgs));
+    }
+
+    public static boolean shouldUseLocalPasswordBackend() {
+        return USE_LOGIN_DATABASE_AS_BACKEND;
+    }
+
+    private PasswordsPreferenceHelper() {}
+}
diff --git a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java
index 7875ef2b37427..0b191043efbb7 100644
--- a/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java
+++ b/chrome/browser/password_manager/android/java/src/org/chromium/chrome/browser/password_manager/settings/PasswordsPreference.java
@@ -63,6 +63,10 @@ public class PasswordsPreference extends ChromeBasePreference implements Profile
         PrefService prefService =
                 sPrefServiceForTesting != null ? sPrefServiceForTesting : UserPrefs.get(mProfile);
 
+        if (org.chromium.chrome.browser.password_manager.PasswordsPreferenceHelper.shouldUseLocalPasswordBackend()) {
+            return;
+        }
+
         if (prefService.isManagedPreference(Pref.CREDENTIALS_ENABLE_SERVICE)) {
             setUpManagedDisclaimerView(holder, prefService);
         }
diff --git a/chrome/browser/password_manager/password_manager_settings_service_factory.cc b/chrome/browser/password_manager/password_manager_settings_service_factory.cc
index aa47f805f57d5..6ab7052644dce 100644
--- a/chrome/browser/password_manager/password_manager_settings_service_factory.cc
+++ b/chrome/browser/password_manager/password_manager_settings_service_factory.cc
@@ -10,6 +10,7 @@
 #include "chrome/browser/webid/federated_identity_auto_reauthn_permission_context.h"
 #include "chrome/browser/webid/federated_identity_auto_reauthn_permission_context_factory.h"
 #include "components/password_manager/core/browser/features/password_features.h"
+#include "components/password_manager/core/browser/password_manager_buildflags.h"
 #include "components/password_manager/core/browser/password_manager_settings_service.h"
 #include "components/password_manager/core/browser/password_manager_settings_service_impl.h"
 #include "components/password_manager/core/common/password_manager_features.h"
@@ -83,7 +84,7 @@ PasswordManagerSettingsServiceFactory::BuildServiceInstanceForBrowserContext(
 
 std::unique_ptr<password_manager::PasswordManagerSettingsService>
 PasswordManagerSettingsServiceFactory::CreateService(Profile* profile) const {
-#if BUILDFLAG(IS_ANDROID)
+#if BUILDFLAG(IS_ANDROID) && !BUILDFLAG(USE_LOGIN_DATABASE_AS_BACKEND)
   // For the first run after the feature is enabled, before the unmigrated
   // passwords are exported, `IsPasswordManagerAvailable` can return false.
   // However, password saving isn't possible in that run anyway.
