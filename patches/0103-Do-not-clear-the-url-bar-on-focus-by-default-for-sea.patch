From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Wed, 15 Nov 2023 09:48:53 +0000
Subject: [PATCH] Do not clear the url bar on focus by default for search
 intents

---
 .../browser/searchwidget/SearchActivity.java      |  1 +
 .../browser/omnibox/LocationBarCoordinator.java   |  4 ++++
 .../browser/omnibox/LocationBarMediator.java      | 15 ++++++++++++++-
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java
index 2e798c51a8a2f..703e1b3308c95 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java
@@ -330,6 +330,7 @@ public class SearchActivity extends AsyncInitializationActivity
         mLocationBarCoordinator.setUrlBarFocusable(true);
         mLocationBarCoordinator.setShouldShowMicButtonWhenUnfocused(true);
         mLocationBarCoordinator.getOmniboxStub().addUrlFocusChangeListener(this);
+        mLocationBarCoordinator.setShouldClearOmniboxByDefault(false);
 
         // Kick off everything needed for the user to type into the box.
         beginQuery();
diff --git a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarCoordinator.java b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarCoordinator.java
index 7c5c5b775f761..eae0594e0c529 100644
--- a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarCoordinator.java
+++ b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarCoordinator.java
@@ -838,4 +838,8 @@ public class LocationBarCoordinator
     public int getUrlActionContainerEndMarginForTesting() {
         return mLocationBarLayout.getUrlActionContainerEndMarginForTesting(); // IN-TEST
     }
+
+    public void setShouldClearOmniboxByDefault(boolean shouldClear) {
+        mLocationBarMediator.setShouldClearOmniboxByDefault(shouldClear);
+    }
 }
diff --git a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarMediator.java b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarMediator.java
index dc9460d7f29e9..0ad759a3b214a 100644
--- a/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarMediator.java
+++ b/chrome/browser/ui/android/omnibox/java/src/org/chromium/chrome/browser/omnibox/LocationBarMediator.java
@@ -200,6 +200,19 @@ class LocationBarMediator
     private ObservableSupplierImpl<Boolean> mBackPressStateSupplier =
             new ObservableSupplierImpl<>();
     private boolean mShouldClearOmniboxOnFocus = true;
+    private boolean mShouldClearOmniboxOnFocusByDefault = true;
+    private volatile boolean mShouldClearOmniboxOnFocusByDefaultSet = false;
+
+    void setShouldClearOmniboxByDefault(boolean shouldClear) {
+        if (mShouldClearOmniboxOnFocusByDefaultSet) {
+            return;
+        }
+
+        mShouldClearOmniboxOnFocus = shouldClear;
+        mShouldClearOmniboxOnFocusByDefault = shouldClear;
+        mShouldClearOmniboxOnFocusByDefaultSet = true;
+    }
+
     private ObservableSupplier<TabModelSelector> mTabModelSelectorSupplier;
     private boolean mIsSurfacePolishOmniboxColorEnabled;
     private SearchEngineUtils mSearchEngineUtils;
@@ -721,7 +734,7 @@ class LocationBarMediator
                             mLocationBarLayout.getMeasuredWidth(), MeasureSpec.EXACTLY));
         }
         // Reset to the default value.
-        mShouldClearOmniboxOnFocus = true;
+        mShouldClearOmniboxOnFocus = mShouldClearOmniboxOnFocusByDefault;
     }
 
     /**
