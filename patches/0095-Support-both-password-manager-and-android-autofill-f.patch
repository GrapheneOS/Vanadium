From f03ff872d68112fa26df2aadbe94a643fc0f78d8 Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Mon, 20 Feb 2023 07:06:53 +0000
Subject: [PATCH] Support both password manager and android autofill
 functionality

---
 .../autofill/content/renderer/autofill_agent.cc     |  1 -
 .../content/renderer/password_autofill_agent.cc     | 11 -----------
 .../core/browser/browser_autofill_manager.cc        | 13 +++++++++++++
 3 files changed, 13 insertions(+), 12 deletions(-)

diff --git a/components/autofill/content/renderer/autofill_agent.cc b/components/autofill/content/renderer/autofill_agent.cc
index 0b00ac4fcc764..74aef5892cadb 100644
--- a/components/autofill/content/renderer/autofill_agent.cc
+++ b/components/autofill/content/renderer/autofill_agent.cc
@@ -541,7 +541,6 @@ void AutofillAgent::OnTextFieldDidChange(const WebInputElement& element) {
   if (password_autofill_agent_->TextDidChangeInTextField(element)) {
     is_popup_possibly_visible_ = true;
     last_queried_element_ = element;
-    return;
   }
 
   ShowSuggestions(element,
diff --git a/components/autofill/content/renderer/password_autofill_agent.cc b/components/autofill/content/renderer/password_autofill_agent.cc
index c43eeb7f502ed..76a7e14737950 100644
--- a/components/autofill/content/renderer/password_autofill_agent.cc
+++ b/components/autofill/content/renderer/password_autofill_agent.cc
@@ -1153,17 +1153,6 @@ bool PasswordAutofillAgent::ShowSuggestions(const WebInputElement& element,
   if (element.Value().length() > kMaximumTextSizeForAutocomplete)
     return false;
 
-#if BUILDFLAG(IS_ANDROID)
-  // Don't call ShowSuggestionPopup if a keyboard replacing surface is currently
-  // showing. Since a keyboard replacing surface in spirit is very similar to a
-  // suggestion pop-up, return true so that the AutofillAgent does not try to
-  // show other autofill suggestions instead.
-  if (keyboard_replacing_surface_state_ ==
-      KeyboardReplacingSurfaceState::kIsShowing) {
-    return true;
-  }
-#endif
-
   if (!HasDocumentWithValidFrame(element))
     return false;
 
diff --git a/components/autofill/core/browser/browser_autofill_manager.cc b/components/autofill/core/browser/browser_autofill_manager.cc
index b40b69691537c..0317bb2595195 100644
--- a/components/autofill/core/browser/browser_autofill_manager.cc
+++ b/components/autofill/core/browser/browser_autofill_manager.cc
@@ -1158,6 +1158,19 @@ void BrowserAutofillManager::OnAskForValuesToFillImpl(
   if (base::FeatureList::IsEnabled(features::kAutofillDisableFilling)) {
     return;
   }
+ 
+  if (AutofillField* _autofill_field = GetAutofillField(form, field)) {
+    switch (_autofill_field->Type().group()) {
+      // Do not override password manager prompt on these fields
+      case FieldTypeGroup::kNoGroup:
+      case FieldTypeGroup::kPasswordField:
+      case FieldTypeGroup::kUsernameField:
+      case FieldTypeGroup::kEmail:
+        return;
+      default:
+        break;
+    }
+  }
 
   external_delegate_->SetCurrentDataListValues(field.datalist_options);
   external_delegate_->OnQuery(form, field, transformed_box);
