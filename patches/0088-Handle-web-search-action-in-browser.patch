From 2e1bb79f06436b6d41870141f15530324e19dadd Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Tue, 12 Jul 2022 11:16:46 +0000
Subject: [PATCH] Handle web search action in browser

---
 .../java/src/org/chromium/base/PackageManagerUtils.java  | 9 +++++++++
 chrome/android/java/AndroidManifest.xml                  | 4 ++++
 .../src/org/chromium/chrome/browser/IntentHandler.java   | 1 +
 .../chromium/chrome/browser/LaunchIntentDispatcher.java  | 3 ++-
 4 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/base/android/java/src/org/chromium/base/PackageManagerUtils.java b/base/android/java/src/org/chromium/base/PackageManagerUtils.java
index 7aa7921e6ec3f..ce223c58ca979 100644
--- a/base/android/java/src/org/chromium/base/PackageManagerUtils.java
+++ b/base/android/java/src/org/chromium/base/PackageManagerUtils.java
@@ -27,6 +27,15 @@ public class PackageManagerUtils {
                                                         .addCategory(Intent.CATEGORY_BROWSABLE)
                                                         .setData(Uri.fromParts("http", "", null));
 
+    public static boolean canSelfHandleIntentActivities(Intent intent) {
+        for (ResolveInfo ri: queryIntentActivities(intent, PackageManager.GET_RESOLVED_FILTER)) {
+            if (ContextUtils.getApplicationContext()
+                    .getPackageName().equals(ri.activityInfo.packageName)) {
+                return true;
+            }
+        }
+        return false;
+    }
     /**
      * Retrieve information about the Activity that will handle the given Intent.
      *
diff --git a/chrome/android/java/AndroidManifest.xml b/chrome/android/java/AndroidManifest.xml
index 15c4f76eff3d7..dcff907aef1f2 100644
--- a/chrome/android/java/AndroidManifest.xml
+++ b/chrome/android/java/AndroidManifest.xml
@@ -324,6 +324,10 @@ by a child template that "extends" this file.
             <intent-filter>
                 <action android:name="android.intent.action.SEARCH" />
             </intent-filter>
+            <intent-filter>  # DOWNSTREAM
+              <action android:name="android.intent.action.WEB_SEARCH"/>
+              <category android:name="android.intent.category.DEFAULT" />
+            </intent-filter>  # DOWNSTREAM
             <intent-filter>
                 <action android:name="com.sec.android.airview.HOVER" />
             </intent-filter>
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java b/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
index 544a555fe895c..477573460b46e 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/IntentHandler.java
@@ -738,6 +738,7 @@ public class IntentHandler {
         String query = null;
         final String action = intent.getAction();
         if (Intent.ACTION_SEARCH.equals(action)
+                || Intent.ACTION_WEB_SEARCH.equals(action)
                 || MediaStore.INTENT_ACTION_MEDIA_SEARCH.equals(action)) {
             query = IntentUtils.safeGetStringExtra(intent, SearchManager.QUERY);
         }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
index 0e8f7c46e4d65..30663e58b6146 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/LaunchIntentDispatcher.java
@@ -207,7 +207,8 @@ public class LaunchIntentDispatcher implements IntentHandler.IntentHandlerDelega
                     PackageManagerUtils
                             .queryIntentActivities(searchIntent, PackageManager.GET_RESOLVED_FILTER)
                             .size();
-            if (resolvers == 0) {
+            if (resolvers == 0
+                    || PackageManagerUtils.canSelfHandleIntentActivities(searchIntent)) {
                 // Phone doesn't have a WEB_SEARCH action handler, open Search Activity with
                 // the given query.
                 Intent searchActivityIntent = new Intent(Intent.ACTION_MAIN);
