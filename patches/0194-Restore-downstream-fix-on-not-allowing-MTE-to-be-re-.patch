From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Wed, 15 Jan 2025 08:38:48 +0000
Subject: [PATCH] Restore downstream fix on not allowing MTE to be re-enabled
 in Android

---
 base/allocator/partition_alloc_support.cc | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/base/allocator/partition_alloc_support.cc b/base/allocator/partition_alloc_support.cc
index 760a4c774f688..d37d6eaae0531 100644
--- a/base/allocator/partition_alloc_support.cc
+++ b/base/allocator/partition_alloc_support.cc
@@ -1067,7 +1067,9 @@ void PartitionAllocSupport::ReconfigureAfterFeatureListInit(
                  "startup (Process: "
               << process_type << ")";
     } else {
-      enable_memory_tagging = ShouldEnableMemoryTagging(process_type);
+      enable_memory_tagging = ShouldEnableMemoryTagging(process_type)
+          && startup_memory_tagging_reporting_mode !=
+              partition_alloc::TagViolationReportingMode::kDisabled;
 #if BUILDFLAG(IS_ANDROID)
       // Android Scudo does not allow MTE to be re-enabled if MTE was disabled.
       if (enable_memory_tagging &&
