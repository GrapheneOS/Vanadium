From 89212fb69c76715e060960649f70480605fde90f Mon Sep 17 00:00:00 2001
From: fgei <fgei@gmail.com>
Date: Mon, 13 Feb 2023 05:04:00 +0000
Subject: [PATCH] Allow versionCode bumping for Android

---
 build/util/android_chrome_version.py |  2 +-
 build/util/version.py                | 12 ++++++++++++
 chrome/version.gni                   | 12 ++++++++++++
 3 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/build/util/android_chrome_version.py b/build/util/android_chrome_version.py
index 910e304bac436..71234246ab2ca 100755
--- a/build/util/android_chrome_version.py
+++ b/build/util/android_chrome_version.py
@@ -281,7 +281,7 @@ def GenerateVersionCodes(version_values, arch, is_next_build):
   """
 
   base_version_code = int(
-      '%s%03d00' % (version_values['BUILD'], int(version_values['PATCH'])))
+      '%s%03d%02d' % (version_values['BUILD'], int(version_values['PATCH']), int(version_values['BUMP'])))
 
   if is_next_build:
     base_version_code += _NEXT_BUILD_VERSION_CODE_DIFF
diff --git a/build/util/version.py b/build/util/version.py
index bf7a59eabf799..e84d739e1c8e2 100755
--- a/build/util/version.py
+++ b/build/util/version.py
@@ -128,6 +128,10 @@ def BuildParser():
                       help='Write substituted strings to FILE.')
   parser.add_argument('-t', '--template', default=None,
                       help='Use TEMPLATE as the strings to substitute.')
+  parser.add_argument(
+      '--bump',
+      default="0",
+      help='Set version bump for base version code.')
   parser.add_argument(
       '-e',
       '--eval',
@@ -197,6 +201,14 @@ def GenerateValues(options, evals):
   """
   values = FetchValues(options.file, options.official)
 
+  try:
+    bump_ver = int(options.bump)
+    if bump_ver > 50 or bump_ver < 0:
+      raise argparse.ArgumentTypeError('"--bump" can only take from 0 to 50 as its int value')
+  except ValueError:
+    raise argparse.ArgumentTypeError('"--bump" can only take integer as its int value')
+  values['BUMP'] = options.bump
+
   for key, val in evals.items():
     values[key] = str(eval(val, globals(), values))
 
diff --git a/chrome/version.gni b/chrome/version.gni
index e197cbe85192b..c68e5bdb2de93 100644
--- a/chrome/version.gni
+++ b/chrome/version.gni
@@ -100,6 +100,18 @@ if (is_mac) {
   if (defined(final_android_sdk) && !final_android_sdk) {
     _script_arguments += [ "--next" ]
   }
+
+  declare_args() {
+    # Enables bumping versionCode for updating within the same Chromium base code
+    android_version_code_bump = ""
+  }
+
+  if (android_version_code_bump != "") {
+    _script_arguments += [
+      "--bump",
+      android_version_code_bump
+    ]
+  }
 }
 
 _script_arguments += [
