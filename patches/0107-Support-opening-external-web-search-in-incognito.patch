From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Sat, 3 Sep 2022 08:15:59 +0200
Subject: [PATCH] Support opening external web search in incognito

---
 chrome/android/chrome_ext_java_sources.gni    |  1 +
 .../browser/searchwidget/SearchActivity.java  |  5 +++++
 .../searchwidget/SearchActivityHooks.java     | 19 +++++++++++++++++++
 3 files changed, 25 insertions(+)
 create mode 100644 chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivityHooks.java

diff --git a/chrome/android/chrome_ext_java_sources.gni b/chrome/android/chrome_ext_java_sources.gni
index 0d29c988b371e..b3a2278b2b251 100644
--- a/chrome/android/chrome_ext_java_sources.gni
+++ b/chrome/android/chrome_ext_java_sources.gni
@@ -7,4 +7,5 @@ chrome_ext_java_sources = [
   "java/src/org/chromium/chrome/browser/privacy/settings/PrivacySettingsExt.java",
   "java/src/org/chromium/chrome/browser/TabPreferencesUtils.java",
   "java/src/org/chromium/chrome/browser/LaunchIntentDispatcherHooks.java",
+  "java/src/org/chromium/chrome/browser/searchwidget/SearchActivityHooks.java",
 ]
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java
index 1f357746143ec..a07d5ac830c4e 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivity.java
@@ -676,6 +676,11 @@ public class SearchActivity extends AsyncInitializationActivity
         Intent intent = SearchActivityUtils.createIntentForStartActivity(params);
         if (intent == null) return;
 
+        intent = SearchActivityHooks.modifyIntentForStartActivity(this, intent);
+        if (intent == null) {
+            return;
+        }
+
         if (mIntentOrigin == IntentOrigin.SEARCH_WIDGET) {
             intent.putExtra(SearchWidgetProvider.EXTRA_FROM_SEARCH_WIDGET, true);
         }
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivityHooks.java b/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivityHooks.java
new file mode 100644
index 0000000000000..0fec563ed19dd
--- /dev/null
+++ b/chrome/android/java/src/org/chromium/chrome/browser/searchwidget/SearchActivityHooks.java
@@ -0,0 +1,19 @@
+package org.chromium.chrome.browser.searchwidget;
+
+import android.app.Activity;
+import android.content.Intent;
+
+import org.chromium.chrome.browser.TabPreferencesUtils;
+import org.chromium.chrome.browser.omnibox.LocationBarCoordinator;
+
+public final class SearchActivityHooks {
+
+    static Intent modifyIntentForStartActivity(Activity activity, Intent intent) {
+        Intent newIntent = intent;
+        if (TabPreferencesUtils.shouldOpenLinksInIncognito()) {
+            newIntent = TabPreferencesUtils.appendNeededIncognitoExtras(activity, newIntent);
+        }
+
+        return newIntent;
+    }
+}
