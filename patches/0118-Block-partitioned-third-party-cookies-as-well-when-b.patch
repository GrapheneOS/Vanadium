From 5fe540133e3e550ca64dee1756d1f3a9bcffaf6a Mon Sep 17 00:00:00 2001
From: quh4gko8 <88831734+quh4gko8@users.noreply.github.com>
Date: Sat, 15 Apr 2023 04:04:47 +0000
Subject: [PATCH] Block partitioned third party cookies as well when blocking
 third party cookies

---
 services/network/cookie_settings.cc | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/services/network/cookie_settings.cc b/services/network/cookie_settings.cc
index fe0e18cb21a47..5e1444d63696e 100644
--- a/services/network/cookie_settings.cc
+++ b/services/network/cookie_settings.cc
@@ -33,6 +33,11 @@ bool IsExplicitSetting(const ContentSettingPatternSource& setting) {
          !setting.secondary_pattern.MatchesAllHosts();
 }
 
+bool IsThirdPartyAllowed(const ContentSettingPatternSource& setting) {
+  return setting.primary_pattern.MatchesAllHosts() &&
+         !setting.secondary_pattern.MatchesAllHosts();
+}
+
 const ContentSettingPatternSource* FindMatchingSetting(
     const GURL& primary_url,
     const GURL& secondary_url,
@@ -195,7 +200,8 @@ CookieSettings::GetThirdPartyBlockingScope(const GURL& first_party_url) const {
   // partitioned cross-site cookies.
   if (const ContentSettingPatternSource* match = FindMatchingSetting(
           first_party_url, first_party_url, content_settings_);
-      !match || match->GetContentSetting() == CONTENT_SETTING_ALLOW) {
+      match && IsThirdPartyAllowed(*match) &&
+      match->GetContentSetting() == CONTENT_SETTING_ALLOW) {
     return ThirdPartyBlockingScope::kUnpartitionedOnly;
   }
   return ThirdPartyBlockingScope::kUnpartitionedAndPartitioned;
